import logging
import sqlite3
from datetime import datetime
import pytz
from telegram import (
    Update, InlineKeyboardButton, InlineKeyboardMarkup
)
from telegram.ext import (
    ApplicationBuilder, CommandHandler, CallbackQueryHandler,
    MessageHandler, ConversationHandler, ContextTypes, filters
)
import asyncio
BOT_TOKEN = "8224143737:AAFPGdsRi9sMomLAk3qWbqEwQbvGU_wHGDg"
ADMIN_ID = 191361082
MOSCOW_TZ = pytz.timezone("Europe/Moscow")
START, CONTACT_REASON, ADMIN_PANEL, CHAT = range(4)
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(message)s")
logger = logging.getLogger(__name__)
def get_db():
    conn = sqlite3.connect("bot.db", check_same_thread=False)
    return conn
def init_db():
    conn = get_db()
    cur = conn.cursor()
    cur.execute("""CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        banned INTEGER DEFAULT 0
    )""")
    cur.execute("""CREATE TABLE IF NOT EXISTS applications (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        reason TEXT,
        status TEXT DEFAULT 'pending',
        created_at TEXT
    )""")
    cur.execute("""CREATE TABLE IF NOT EXISTS active_chats (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        admin_id INTEGER,
        user_id INTEGER,
        log_file TEXT,
        started_at TEXT
    )""")
    conn.commit()
    conn.close()
def is_banned(uid: int):
    conn = get_db()
    cur = conn.cursor()
    cur.execute("SELECT banned FROM users WHERE user_id=?", (uid,))
    row = cur.fetchone()
    conn.close()
    return bool(row and row[0])
def get_time():
    aware = datetime.now(MOSCOW_TZ)
    naive = aware.replace(tzinfo=None)
    return aware, naive

def get_active_chat(user_id: int):
    conn = get_db()
    cur = conn.cursor()
    cur.execute("SELECT * FROM active_chats WHERE user_id=? OR admin_id=?", (user_id, user_id))
    chat = cur.fetchone()
    conn.close()
    return chat

def get_all_active_chats():
    conn = get_db()
    cur = conn.cursor()
    cur.execute("SELECT * FROM active_chats")
    chats = cur.fetchall()
    conn.close()
    return chats

def set_active_chat(admin_id: int, user_id: int, log_file: str):
    conn = get_db()
    cur = conn.cursor()
    _, naive = get_time()

    cur.execute("DELETE FROM active_chats WHERE admin_id=? OR user_id=?", (admin_id, user_id))
    cur.execute("INSERT INTO active_chats (admin_id, user_id, log_file, started_at) VALUES (?,?,?,?)",
                (admin_id, user_id, log_file, naive))
    conn.commit()
    conn.close()

def end_active_chat(user_id: int):
    conn = get_db()
    cur = conn.cursor()
    cur.execute("DELETE FROM active_chats WHERE user_id=? OR admin_id=?", (user_id, user_id))
    conn.commit()
    conn.close()

async def cleanup_active_chats(context: ContextTypes.DEFAULT_TYPE):

    conn = get_db()
    cur = conn.cursor()
    cur.execute("SELECT * FROM active_chats")
    active_chats = cur.fetchall()
    conn.close()
    
    for chat in active_chats:
        chat_id, admin_id, user_id, log_file, started_at = chat
        if log_file:
            try:
                with open(log_file, "a", encoding="utf-8") as f:
                    f.write(f"–ß–ê–¢ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ó–ê–í–ï–†–®–ï–ù –ü–†–ò –ü–ï–†–ï–ó–ê–ü–£–°–ö–ï –ë–û–¢–ê {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥: {e}")

        try:
            await context.bot.send_message(user_id, "üîö –ë–æ—Ç –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω. –ß–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à—ë–Ω. –ï—Å–ª–∏ —É –≤–∞—Å –æ—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã, —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É.")
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")

        try:
            await context.bot.send_message(admin_id, f"üîö –ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id} –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à—ë–Ω –∏–∑-–∑–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.")
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")

    conn = get_db()
    cur = conn.cursor()
    cur.execute("DELETE FROM active_chats")
    conn.commit()
    conn.close()
    
    logger.info(f"–ó–∞–≤–µ—Ä—à–µ–Ω–æ {len(active_chats)} –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞")
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    active_chat = get_active_chat(user.id)
    if active_chat:
        context.chat_data["active_chat"] = active_chat[2] if user.id == ADMIN_ID else ADMIN_ID
        context.user_data["log_file"] = active_chat[3]
        
        if user.id == ADMIN_ID:
            kb = [
                [InlineKeyboardButton("üîö –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç", callback_data="end_chat")],
                [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_start")]
            ]
            if update.message:
                await update.message.reply_text("üí¨ –£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ–±—â–µ–Ω–∏–µ.", reply_markup=InlineKeyboardMarkup(kb))
            else:
                await update.callback_query.edit_message_text("üí¨ –£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ–±—â–µ–Ω–∏–µ.", reply_markup=InlineKeyboardMarkup(kb))
        else:
            kb = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_start")]]
            if update.message:
                await update.message.reply_text("üí¨ –£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ–±—â–µ–Ω–∏–µ.", reply_markup=InlineKeyboardMarkup(kb))
            else:
                await update.callback_query.edit_message_text("üí¨ –£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ–±—â–µ–Ω–∏–µ.", reply_markup=InlineKeyboardMarkup(kb))
        return CHAT
    
    if is_banned(user.id):
        if update.message:
            await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        else:
            await update.callback_query.edit_message_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return ConversationHandler.END
    
    conn = get_db()
    cur = conn.cursor()
    cur.execute("INSERT OR IGNORE INTO users (user_id, username) VALUES (?,?)", (user.id, user.username))
    conn.commit()
    conn.close()

    kb = [[InlineKeyboardButton("üìû –°–≤—è–∑–∞—Ç—å—Å—è", callback_data="contact")]]
    if user.id == ADMIN_ID:
        kb.append([InlineKeyboardButton("üë®‚Äçüíª –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel")])
    
    if update.message:
        await update.message.reply_text("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=InlineKeyboardMarkup(kb))
    else:
        await update.callback_query.edit_message_text("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=InlineKeyboardMarkup(kb))
    
    return START
async def contact(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    kb = [[InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="back_start")]]
    await query.edit_message_text(
        "–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ–±—Ä–∞—â–µ–Ω–∏—è:", 
        reply_markup=InlineKeyboardMarkup(kb)
    )
    return CONTACT_REASON

async def handle_reason(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    reason = update.message.text
    
    if is_banned(user.id):
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return START
    _, naive = get_time()
    conn = get_db()
    cur = conn.cursor()
    cur.execute("INSERT INTO applications (user_id, reason, created_at) VALUES (?,?,?)",
                (user.id, reason, naive))
    conn.commit()
    conn.close()
    kb = [
        [
            InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç—å", callback_data=f"accept_{user.id}"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_{user.id}")
        ],
        [InlineKeyboardButton("üö´ –ó–∞–±–∞–Ω–∏—Ç—å", callback_data=f"ban_{user.id}")]
    ]
    await context.bot.send_message(
        ADMIN_ID,
        f"üì® –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –æ—Ç @{user.username or '–±–µ–∑ username'} (ID: {user.id})\n\n–ü—Ä–∏—á–∏–Ω–∞: {reason}",
        reply_markup=InlineKeyboardMarkup(kb)
    )
    
    await update.message.reply_text("‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.")
    return await start(update, context)
async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    kb = [
        [InlineKeyboardButton("üìÑ –í—Å–µ –∑–∞—è–≤–∫–∏", callback_data="all_apps")],
        [InlineKeyboardButton("üí¨ –ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã", callback_data="active_chats")],
        [InlineKeyboardButton("üö´ –°–ø–∏—Å–æ–∫ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö", callback_data="ban_list")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_start")]
    ]
    await query.edit_message_text("üë®‚Äçüíª –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", reply_markup=InlineKeyboardMarkup(kb))
    return ADMIN_PANEL
async def handle_application_action(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    if any(data.startswith(prefix) for prefix in ["accept_", "reject_", "ban_", "unban_"]):
        try:
            parts = data.split('_')
            if len(parts) < 2:
                return ADMIN_PANEL
            action = parts[0]
            uid_str = parts[1]
            if not uid_str.isdigit():
                return ADMIN_PANEL
                
            uid = int(uid_str)
            
        except (ValueError, IndexError):
            logger.error(f"Invalid callback data: {data}")
            return ADMIN_PANEL
        
        conn = get_db()
        cur = conn.cursor()

        if action == "accept":
            existing_chat = get_active_chat(ADMIN_ID)
            if existing_chat:
                await query.edit_message_text("‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–≥–æ.")
                conn.close()
                return ADMIN_PANEL
            cur.execute("UPDATE applications SET status='accepted' WHERE user_id=? AND status='pending'", (uid,))
            conn.commit()

            filename = f"chat_{uid}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"

            set_active_chat(ADMIN_ID, uid, filename)

            context.chat_data["active_chat"] = uid
            context.user_data["log_file"] = filename
            
            with open(filename, "w", encoding="utf-8") as f:
                f.write(f"–ß–ê–¢ –ù–ê–ß–ê–¢ {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n")
            
            await context.bot.send_message(uid, "‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–∏–Ω—è–ª –≤–∞—à—É –∑–∞—è–≤–∫—É –∏ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥. –ú–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è!")
            
            kb = [
                [InlineKeyboardButton("üîö –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç", callback_data="end_chat")],
                [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")]
            ]
            await context.bot.send_message(
                ADMIN_ID, 
                f"üí¨ –î–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (ID: {uid}) –Ω–∞—á–∞—Ç. –ú–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è!", 
                reply_markup=InlineKeyboardMarkup(kb)
            )
            
            await query.edit_message_text("‚úÖ –î–∏–∞–ª–æ–≥ –Ω–∞—á–∞—Ç. –ú–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.")
            conn.close()
            return CHAT

        elif action == "reject":
            cur.execute("UPDATE applications SET status='rejected' WHERE user_id=? AND status='pending'", (uid,))
            conn.commit()
            await context.bot.send_message(uid, "‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.")
            
            kb = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")]]
            await query.edit_message_text("‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.", reply_markup=InlineKeyboardMarkup(kb))
            conn.close()
            return ADMIN_PANEL

        elif action == "ban":
            cur.execute("UPDATE users SET banned=1 WHERE user_id=?", (uid,))
            conn.commit()
            await context.bot.send_message(uid, "üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
            
            kb = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")]]
            await query.edit_message_text("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.", reply_markup=InlineKeyboardMarkup(kb))
            conn.close()
            return ADMIN_PANEL

        elif action == "unban":
            cur.execute("UPDATE users SET banned=0 WHERE user_id=?", (uid,))
            conn.commit()
            
            kb = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")]]
            await query.edit_message_text("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω.", reply_markup=InlineKeyboardMarkup(kb))
            conn.close()
            return ADMIN_PANEL
    
    return ADMIN_PANEL
async def end_chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    active_chat = get_active_chat(ADMIN_ID)
    if active_chat:
        user_id = active_chat[2]
        log_file = active_chat[3]
        
        if log_file:
            try:
                with open(log_file, "a", encoding="utf-8") as f:
                    f.write(f"–ß–ê–¢ –ó–ê–í–ï–†–®–ï–ù {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n")
            except:
                pass
        try:
            await context.bot.send_message(user_id, "üîö –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª –¥–∏–∞–ª–æ–≥. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É.")
        except:
            pass
        end_active_chat(ADMIN_ID)
    context.chat_data.pop("active_chat", None)
    context.user_data.pop("log_file", None)
    
    await query.edit_message_text("‚úÖ –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à—ë–Ω.")
    return await admin_panel(update, context)
async def chat_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    message = update.message
    active_chat_data = get_active_chat(user_id)
    if not active_chat_data:
        await start(update, context)
        return START
    admin_id = active_chat_data[1]
    user_id_in_chat = active_chat_data[2]
    log_file = active_chat_data[3]
    if log_file and message.text:
        try:
            with open(log_file, "a", encoding="utf-8") as f:
                username = update.effective_user.username or f"ID{user_id}"
                f.write(f"{datetime.now().strftime('%H:%M:%S')} {username}: {message.text}\n")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥: {e}")
    try:
        if user_id == admin_id:
            if message.text:
                await context.bot.send_message(user_id_in_chat, f"üë®‚Äçüíª –ê–¥–º–∏–Ω: {message.text}")
            else:
                await context.bot.copy_message(user_id_in_chat, admin_id, message.message_id)
        else:
            if message.text:
                await context.bot.send_message(admin_id, f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.text}")
            else:
                await context.bot.copy_message(admin_id, user_id, message.message_id)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        if user_id == admin_id:
            await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞?")
    return CHAT
async def all_applications(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    conn = get_db()
    cur = conn.cursor()
    cur.execute("""
        SELECT a.id, a.user_id, u.username, a.reason, a.status, a.created_at 
        FROM applications a 
        LEFT JOIN users u ON a.user_id = u.user_id 
        ORDER BY a.created_at DESC LIMIT 10
    """)
    rows = cur.fetchall()
    conn.close()
    
    if not rows:
        await query.edit_message_text("üì≠ –ù–µ—Ç –∑–∞—è–≤–æ–∫.")
        return ADMIN_PANEL
    text = "üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞—è–≤–æ–∫:\n\n"
    for app_id, user_id, username, reason, status, created_at in rows:
        status_icon = "üü¢" if status == "accepted" else "üî¥" if status == "rejected" else "üü°"
        text += f"{status_icon} #{app_id} - @{username or 'no_username'} (ID: {user_id})\n"
        text += f"üìù {reason[:50]}{'...' if len(reason) > 50 else ''}\n"
        text += f"üïê {created_at}\n\n"
    kb = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")]]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(kb))
    return ADMIN_PANEL
async def active_chats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    active_chats = get_all_active_chats()
    if not active_chats:
        await query.edit_message_text("üí¨ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤.")
        return ADMIN_PANEL
    text = "üí¨ –ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã:\n\n"
    kb = []
    for chat in active_chats:
        chat_id, admin_id, user_id, log_file, started_at = chat
        conn = get_db()
        cur = conn.cursor()
        cur.execute("SELECT username FROM users WHERE user_id=?", (user_id,))
        row = cur.fetchone()
        conn.close()
        username = row[0] if row else "–Ω–µ—Ç username"
        
        text += f"üë§ @{username} (ID: {user_id})\n"
        text += f"üïê –ù–∞—á–∞—Ç: {started_at}\n"
        text += "‚îÄ" * 20 + "\n"
        kb.append([InlineKeyboardButton(f"üí¨ –ß–∞—Ç —Å @{username}", callback_data=f"accept_{user_id}")])
    kb.append([InlineKeyboardButton("üîö –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã", callback_data="end_all_chats")])
    kb.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")])
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(kb))
    return ADMIN_PANEL
async def end_all_chats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    active_chats = get_all_active_chats()
    for chat in active_chats:
        chat_id, admin_id, user_id, log_file, started_at = chat
        if log_file:
            try:
                with open(log_file, "a", encoding="utf-8") as f:
                    f.write(f"–ß–ê–¢ –ó–ê–í–ï–†–®–ï–ù {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n")
            except:
                pass
        try:
            await context.bot.send_message(user_id, "üîö –í—Å–µ —á–∞—Ç—ã –±—ã–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
        except:
            pass
    conn = get_db()
    cur = conn.cursor()
    cur.execute("DELETE FROM active_chats")
    conn.commit()
    conn.close()
    await query.edit_message_text("‚úÖ –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã.")
    return await admin_panel(update, context)
async def show_ban_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    conn = get_db()
    cur = conn.cursor()
    cur.execute("SELECT user_id, username FROM users WHERE banned=1")
    rows = cur.fetchall()
    conn.close()
    if not rows:
        await query.edit_message_text("üö´ –°–ø–∏—Å–æ–∫ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö –ø—É—Å—Ç.")
        return ADMIN_PANEL
    text = "üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n\n"
    kb = []
    for uid, username in rows:
        display_name = f"@{username}" if username else f"ID: {uid}"
        text += f"‚Ä¢ {display_name}\n"
        kb.append([InlineKeyboardButton(f"üîì –†–∞–∑–±–∞–Ω–∏—Ç—å {display_name}", callback_data=f"unban_{uid}")])
    kb.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")])
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(kb))
    return ADMIN_PANEL
async def back_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user = update.effective_user
    kb = [[InlineKeyboardButton("üìû –°–≤—è–∑–∞—Ç—å—Å—è", callback_data="contact")]]
    if user.id == ADMIN_ID:
        kb.append([InlineKeyboardButton("üë®‚Äçüíª –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel")])
    await query.edit_message_text(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", 
        reply_markup=InlineKeyboardMarkup(kb)
    )
    return START
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    active_chat = get_active_chat(user.id)
    if active_chat:
        end_active_chat(user.id)
    await update.message.reply_text("‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    return await start(update, context)
async def handle_unhandled_messages(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    active_chat = get_active_chat(user_id)
    if active_chat:
        return await chat_handler(update, context)
    else:
        return await start(update, context)

async def post_init(application):
    await cleanup_active_chats(application.bot_data)
def main():
    init_db()
    application = ApplicationBuilder().token(BOT_TOKEN).build()
    application.add_handler(CallbackQueryHandler(handle_application_action, pattern="^(accept|reject|ban|unban)_[0-9]+$"))
    application.add_handler(CallbackQueryHandler(end_all_chats, pattern="^end_all_chats$"))

    conv = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            START: [
                CallbackQueryHandler(contact, pattern="^contact$"),
                CallbackQueryHandler(admin_panel, pattern="^admin_panel$"),
                CallbackQueryHandler(back_start, pattern="^back_start$")
            ],
            CONTACT_REASON: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_reason),
                CallbackQueryHandler(back_start, pattern="^back_start$")
            ],
            ADMIN_PANEL: [
                CallbackQueryHandler(all_applications, pattern="^all_apps$"),
                CallbackQueryHandler(active_chats, pattern="^active_chats$"),
                CallbackQueryHandler(show_ban_list, pattern="^ban_list$"),
                CallbackQueryHandler(admin_panel, pattern="^admin_panel$"),
                CallbackQueryHandler(back_start, pattern="^back_start$"),
                CallbackQueryHandler(end_chat, pattern="^end_chat$")
            ],
            CHAT: [
                CallbackQueryHandler(end_chat, pattern="^end_chat$"),
                CallbackQueryHandler(back_start, pattern="^back_start$"),
                MessageHandler(filters.ALL & ~filters.COMMAND, chat_handler)
            ]
        },
        fallbacks=[CommandHandler("cancel", cancel), CommandHandler("start", start)],
        allow_reentry=True
    )

    application.add_handler(conv)
    application.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_unhandled_messages))
    application.run_polling()
    print("‚úÖ BOT STARTED")
if __name__ == "__main__":
    main()
